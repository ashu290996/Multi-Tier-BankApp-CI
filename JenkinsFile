pipeline {
    agent any

    tools {
        maven 'maven3'
        jdk 'jdk21'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        APP_VERSION  = "1.0.${BUILD_NUMBER}"
    }

    parameters {
        booleanParam(name: 'RUN_GIT_CHECKOUT', defaultValue: true, description: 'Run Git checkout stage')
        booleanParam(name: 'RUN_MVN_COMPILE', defaultValue: true, description: 'Run MVN Compile stage')
        booleanParam(name: 'RUN_MVN_TEST', defaultValue: true, description: 'Run MVN Test stage')
        booleanParam(name: 'RUN_MVN_PACKAGE', defaultValue: true, description: 'Run MVN package stage')
        booleanParam(name: 'RUN_NEXUS_UPLOAD', defaultValue: true, description: 'Run Nexus_upload stage')
        booleanParam(name: 'RUN_SONAR', defaultValue: true, description: 'Run SonarQube analysis')
        booleanParam(name: 'RUN_OWASP', defaultValue: true, description: 'Run OWASP scan')
        booleanParam(name: 'RUN_DOCKER_BUILD', defaultValue: true, description: 'Build and push Docker images')
        booleanParam(name: 'RUN_TRIVY', defaultValue: true, description: 'Run Trivy scan')
        booleanParam(name: 'RUN_GIT_CHECKOUT1', defaultValue: true, description: 'Run Git checkout stage1')
        booleanParam(name: 'RUN_DEPLOY_CONTAINER', defaultValue: true, description: 'Run Deploy to container')
    }

    stages {

        stage('Git checkout') {
            when { expression { params.RUN_GIT_CHECKOUT } }
            steps {
                script {
                    try {
                        git branch: 'master',
                            credentialsId: 'github-login',
                            url: 'https://github.com/ashu290996/Multi-Tier-BankApp-CI.git'
                    } catch (Exception e) {
                        echo "Git checkout failed: ${e.getMessage()}"
                        error("Stopping pipeline due to Git checkout failure")
                    }
                }
            }
        }

        stage('Set Build Version') {
            steps {
                script {
                    try {
                        sh """
                        mvn versions:set \
                          -DnewVersion=${APP_VERSION} \
                          -DgenerateBackupPoms=false
                        """
                    } catch (Exception e) {
                        echo "Set Build Version failed: ${e.getMessage()}"
                        error("Stopping pipeline due to version set failure")
                    }
                }
            }
        }

        stage('MVN compile') {
            when { expression { params.RUN_MVN_COMPILE } }
            steps {
                script {
                    try {
                        sh "mvn compile"
                    } catch (Exception e) {
                        echo "MVN compile failed: ${e.getMessage()}"
                        error("Stopping pipeline due to compile failure")
                    }
                }
            }
        }

        stage('MVN test') {
            when { expression { params.RUN_MVN_TEST } }
            steps {
                script {
                    try {
                        sh "mvn test"
                    } catch (Exception e) {
                        echo "MVN test failed: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                        // Continue pipeline even if tests fail
                    }
                }
            }
        }

        stage('MVN package') {
            when { expression { params.RUN_MVN_PACKAGE } }
            steps {
                script {
                    try {
                        sh "mvn clean package -DskipTests=true"
                    } catch (Exception e) {
                        echo "MVN package failed: ${e.getMessage()}"
                        error("Stopping pipeline due to package failure")
                    }
                }
            }
        }

        stage('Nexus Upload') {
            when { expression { params.RUN_NEXUS_UPLOAD } }
            steps {
                script {
                    try {
                        withMaven(
                            globalMavenSettingsConfig: 'Global-maven-setting',
                            jdk: 'jdk21',
                            maven: 'maven3',
                            traceability: true
                        ) {
                            sh "mvn deploy -DskipTests=true"
                        }
                    } catch (Exception e) {
                        echo "Nexus upload failed: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                        // Continue pipeline even if Nexus upload fails
                    }
                }
            }
        }

        stage('Parallel Scans & Docker') {
            parallel {

                stage('Sonar Analysis') {
                    when { expression { params.RUN_SONAR } }
                    steps {
                        script {
                            try {
                                withSonarQubeEnv('sonar-scanner') {
                                    sh """
                                    ${SCANNER_HOME}/bin/sonar-scanner \
                                      -Dsonar.java.binaries=. \
                                      -Dsonar.projectName=Multi-Tier-BankApp-CI \
                                      -Dsonar.projectKey=Multi-Tier-BankApp-CI
                                    """
                                }
                            } catch (Exception e) {
                                echo "SonarQube analysis failed: ${e.getMessage()}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }

                stage('OWASP Scan') {
                    when { expression { params.RUN_OWASP } }
                    steps {
                        script {
                            try {
                                dependencyCheck additionalArguments: '--scan ./', odcInstallation: 'DP-check'
                                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                            } catch (Exception e) {
                                echo "OWASP scan failed: ${e.getMessage()}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }

                stage('Create Docker Image') {
                    when { expression { params.RUN_DOCKER_BUILD } }
                    steps {
                        script {
                            try {
                                withDockerRegistry(credentialsId: 'dockerhub', url: 'https://index.docker.io/v1/') {
                                    sh """
                                    docker build -t ashu290996/bankapp:${APP_VERSION} .
                                    docker tag ashu290996/bankapp:${APP_VERSION} ashu290996/bankapp:latest
                                    docker push ashu290996/bankapp:${APP_VERSION}
                                    docker push ashu290996/bankapp:latest
                                    """
                                }
                            } catch (Exception e) {
                                echo "Docker build/push failed: ${e.getMessage()}"
                                error("Stopping pipeline due to Docker failure")
                            }
                        }
                    }
                }

                stage('Run Trivy') {
                    when { expression { params.RUN_TRIVY } }
                    steps {
                        script {
                            try {
                                sh "trivy image --format table -o image.html ashu290996/bankapp:${APP_VERSION}"
                            } catch (Exception e) {
                                echo "Trivy scan failed: ${e.getMessage()}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }

        stage('Git checkout CD') {
            when { expression { params.RUN_GIT_CHECKOUT1 } }
            steps {
                script {
                    try {
                        git branch: 'master',
                            credentialsId: 'github-login',
                            url: 'https://github.com/ashu290996/Multi-Tier-BankApp-CD.git'
                    } catch (Exception e) {
                        echo "Git checkout CD failed: ${e.getMessage()}"
                        error("Stopping pipeline due to Git checkout failure")
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            when { expression { params.RUN_DEPLOY_CONTAINER } }
            steps {
                script {
                    try {
                        withKubeConfig(
                            credentialsId: 'k8-prod-token',
                            namespace: 'prod',
                            serverUrl: 'https://bankapp-dns-prn5mjxo.hcp.eastus.azmk8s.io:443'
                        ) {
                            sh """
                            kubectl apply -f bankapp/bankapp-ds.yml -n prod
                            kubectl apply -f database/database-ds.yml -n prod
                            kubectl set image deployment bankapp-deployment \
                              bankapp=ashu290996/bankapp:${APP_VERSION} -n prod
                            """
                        }
                    } catch (Exception e) {
                        echo "Kubernetes deployment failed: ${e.getMessage()}"
                        error("Stopping pipeline due to deployment failure")
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished with status: ${currentBuild.currentResult}"
            // Clean up workspace
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully!"
            // Add notification here (email, Slack, etc.)
            // slackSend channel: '#deployments', message: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
        failure {
            echo "Pipeline failed!"
            // Add notification here
            // slackSend channel: '#deployments', color: 'danger', message: "FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }
        unstable {
            echo "Pipeline completed with warnings (UNSTABLE)"
            // Add notification here
        }
    }
}
