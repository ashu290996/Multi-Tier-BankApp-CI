pipeline {
    agent any

    tools {
        maven 'maven3'
        jdk 'jdk21'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        APP_VERSION  = "1.0.${BUILD_NUMBER}"
    }

    parameters {
        booleanParam(name: 'RUN_GIT_CHECKOUT', defaultValue: true, description: 'Run Git checkout stage')
        booleanParam(name: 'RUN_MVN_COMPILE', defaultValue: true, description: 'Run MVN Compile stage')
        booleanParam(name: 'RUN_MVN_TEST', defaultValue: true, description: 'Run MVN Test stage')
        booleanParam(name: 'RUN_MVN_PACKAGE', defaultValue: true, description: 'Run MVN package stage')
        booleanParam(name: 'RUN_NEXUS_UPLOAD', defaultValue: true, description: 'Run Nexus_upload stage')
        booleanParam(name: 'RUN_SONAR', defaultValue: true, description: 'Run SonarQube analysis')
        booleanParam(name: 'RUN_OWASP', defaultValue: true, description: 'Run OWASP scan')
        booleanParam(name: 'RUN_DOCKER_BUILD', defaultValue: true, description: 'Build and push Docker images')
        booleanParam(name: 'RUN_TRIVY', defaultValue: true, description: 'Run Trivy scan')
        booleanParam(name: 'RUN_GIT_CHECKOUT1', defaultValue: true, description: 'Run Git checkout stage1')
        booleanParam(name: 'RUN_DEPLOY_CONTAINER', defaultValue: true, description: 'Run Deploy to container')
    }

    stages {

        stage('Git checkout') {
            when { expression { params.RUN_GIT_CHECKOUT } }
            steps {
                git branch: 'master',
                    credentialsId: 'github-login',
                    url: 'https://github.com/ashu290996/Multi-Tier-BankApp-CI.git'
            }
        }

        stage('Set Build Version') {
            steps {
                sh """
                mvn versions:set \
                  -DnewVersion=${APP_VERSION} \
                  -DgenerateBackupPoms=false
                """
            }
        }

        stage('MVN compile') {
            when { expression { params.RUN_MVN_COMPILE } }
            steps {
                sh "mvn compile"
            }
        }

        stage('MVN test') {
            when { expression { params.RUN_MVN_TEST } }
            steps {
                sh "mvn test"
            }
        }

        stage('MVN package') {
            when { expression { params.RUN_MVN_PACKAGE } }
            steps {
                sh "mvn clean package -DskipTests=true"
            }
        }

        stage('Nexus Upload') {
            when { expression { params.RUN_NEXUS_UPLOAD } }
            steps {
                withMaven(
                    globalMavenSettingsConfig: 'Global-maven-setting',
                    jdk: 'jdk21',
                    maven: 'maven3',
                    traceability: true
                ) {
                    sh "mvn deploy -DskipTests=true"
                }
            }
        }

        parallel {

            stage('Sonar Analysis') {
                when { expression { params.RUN_SONAR } }
                steps {
                    withSonarQubeEnv('sonar-scanner') {
                        sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                          -Dsonar.java.binaries=. \
                          -Dsonar.projectName=Multi-Tier-BankApp-CI \
                          -Dsonar.projectKey=Multi-Tier-BankApp-CI
                        """
                    }
                }
            }

            stage('OWASP Scan') {
                when { expression { params.RUN_OWASP } }
                steps {
                    dependencyCheck additionalArguments: '--scan ./', odcInstallation: 'DP-check'
                    dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                }
            }

            stage('Create Docker Image') {
                when { expression { params.RUN_DOCKER_BUILD } }
                steps {
                    withDockerRegistry(credentialsId: 'dockerhub', url: 'https://index.docker.io/v1/') {
                        sh """
                        docker build -t ashu290996/bankapp:${APP_VERSION} .
                        docker tag ashu290996/bankapp:${APP_VERSION} ashu290996/bankapp:latest
                        docker push ashu290996/bankapp:${APP_VERSION}
                        docker push ashu290996/bankapp:latest
                        """
                    }
                }
            }

            stage('Run Trivy') {
                when { expression { params.RUN_TRIVY } }
                steps {
                    sh "trivy image --format table -o image.html ashu290996/bankapp:${APP_VERSION}"
                }
            }
        }

        stage('Git checkout CD') {
            when { expression { params.RUN_GIT_CHECKOUT1 } }
            steps {
                git branch: 'master',
                    credentialsId: 'github-login',
                    url: 'https://github.com/ashu290996/Multi-Tier-BankApp-CD.git'
            }
        }

        stage('Deploy to Kubernetes') {
            when { expression { params.RUN_DEPLOY_CONTAINER } }
            steps {
                withKubeConfig(
                    credentialsId: 'k8-prod-token',
                    namespace: 'prod',
                    serverUrl: 'https://bankapp-dns-prn5mjxo.hcp.eastus.azmk8s.io:443'
                ) {
                    sh """
                    kubectl apply -f bankapp/bankapp-ds.yml -n prod
                    kubectl apply -f database/database-ds.yml -n prod
                    kubectl set image deployment bankapp-deployment \
                      bankapp=ashu290996/bankapp:${APP_VERSION} -n prod
                    """
                }
            }
        }
    }
}
